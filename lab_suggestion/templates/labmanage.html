
{% extends 'base.html' %}

{% block title %}Lab Test Management - LabEase{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-4">Manage Tests for {{ lab.name }}</h1>

    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Add a New Test</h2>
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="bg-blue-500 text-white rounded-md px-4 py-2 hover:bg-blue-600">Add Test</button>
        </form>
    </div>

    <!-- Excel Bulk Upload Form (Lab-Only) -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
      <h3 class="text-2xl font-bold text-gray-800 mb-4">Bulk Upload Tests via Excel</h3>
      <p class="text-gray-600 mb-4">
        <strong>Notes:</strong>
        <ul>
          <li>The labâ€™s name/address is auto-linked to the logged-in lab user</li>
          <li>Missing values (e.g., description) can be left blank</li>
          <li>Prices must be numeric (no currency symbols)</li>
        </ul>
      </p>
      <form method="post" enctype="multipart/form-data" action="{% url 'lab_upload_tests_excel' %}"> {# Corrected URL #}
        {% csrf_token %}
        {{ excel_upload_form.as_p }}
        <button type="submit" class="bg-blue-500 text-white rounded-md px-4 py-2 hover:bg-blue-600">Upload Excel File</button>
      </form>
    </div>

    <!-- Messages Section -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Messages for Your Lab</h2>
        {% if lab_messages %}
            <table class="min-w-full bg-white">
                <thead>
                    <tr>
                        <th class="py-2">Sender</th>
                        <th class="py-2">Email</th>
                        <th class="py-2">Timestamp</th>
                        <th class="py-2">Message</th>
                        <th class="py-2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for message in lab_messages %}
                        <tr class="border-b">
                            <td class="py-2 px-4">{{ message.name }}</td>
                            <td class="py-2 px-4">{{ message.email }}</td>
                            <td class="py-2 px-4">{{ message.sent_at|date:"Y-m-d H:i" }}</td>
                            <td class="py-2 px-4">{{ message.message }}</td>
                            <td class="py-2 px-4">
                                <form action="{% url 'delete_message' message.id %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="bg-red-500 text-white rounded-md px-3 py-1 hover:bg-red-600 text-sm">Delete</button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="py-4 text-center text-gray-500">No messages for your lab yet.</p>
        {% endif %}
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Your Offered Tests</h2>
        <table class="min-w-full bg-white">
            <thead>
                <tr>
                    <th class="py-2">Test Name</th>
                    <th class="py-2">Description</th>
                    <th class="py-2">Price</th>
                    <th class="py-2">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for test in tests %}
                <tr class="border-b">
                    <td class="py-2 px-4">{{ test.name }}</td>
                    <td class="py-2 px-4">{{ test.description|default:"N/A" }}</td>
                    <td class="py-2 px-4">RS.{{ test.price|default:"Not set" }}</td>
                    <td class="py-2 px-4">
                        <a href="{% url 'edit_test' test.id %}" class="text-blue-500 hover:underline">Edit</a>
                        <a href="{% url 'delete_test' test.id %}" class="text-red-500 hover:underline ml-4">Delete</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" class="py-4 text-center text-gray-500">You have not added any tests yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="container mx-auto px-6 py-4 text-right">
    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit" class="bg-red-500 text-white rounded-md px-4 py-2 hover:bg-red-600">Logout</button>
    </form>
</div>
{% endblock %}